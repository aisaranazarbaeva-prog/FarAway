{% extends 'tickets/base.html' %}
{% block title %}–ë–∏–ª–µ—Ç—ã ‚Äî FarAway.kg{% endblock %}

{% block content %}
<div class="py-5" style="background: linear-gradient(to top, #e0f7ff, #ffffff); min-height: 100vh;">
  <div class="container">
    <h2 class="mb-4 text-center fw-bold text-primary display-5">–ù–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–µ–π—Å ‚úàÔ∏è</h2>
      <form method="get" class="row g-3 mb-5">
      <div class="col-md-5">
        <input type="text" name="origin" class="form-control rounded-pill border-primary px-4 py-2 shadow-sm" placeholder="–û—Ç–∫—É–¥–∞" value="{{ request.GET.origin }}">
      </div>
      <div class="col-md-5">
        <input type="text" name="destination" class="form-control rounded-pill border-primary px-4 py-2 shadow-sm" placeholder="–ö—É–¥–∞" value="{{ request.GET.destination }}">
      </div>
      <div class="col-md-2 d-grid">
        <button type="submit" class="btn btn-gradient fw-bold rounded-pill py-2">üîç –ü–æ–∏—Å–∫</button>
      </div>
    </form>

    <!-- –§–∏–ª—å—Ç—Ä –ü—Ä—è–º–æ–π / –° –ø–µ—Ä–µ—Å–∞–¥–∫–æ–π -->
    <form method="get" class="mb-4 d-flex gap-2 flex-wrap">
      <select class="form-select w-auto" name="direct" onchange="this.form.submit()">
        <option value="">–¢–∏–ø —Ä–µ–π—Å–∞</option>
        <option value="direct" {% if request.GET.direct == 'direct' %}selected{% endif %}>–ü—Ä—è–º–æ–π</option>
        <option value="transfer" {% if request.GET.direct == 'transfer' %}selected{% endif %}>–° –ø–µ—Ä–µ—Å–∞–¥–∫–æ–π</option>
      </select>
    </form>

    <!-- –°–µ—Ç–∫–∞ –±–∏–ª–µ—Ç–æ–≤ -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for t in tickets %}
      <div class="col">
        <div class="card h-100 shadow-lg border-0 rounded-4 overflow-hidden ticket-card bg-white position-relative">

          <!-- Badge –ê–∫—Ü–∏—è / –ü–æ–ø—É–ª—è—Ä–Ω—ã–π -->
          {% if forloop.counter0|divisibleby:3 %}
          <span class="position-absolute top-0 start-0 m-2 badge bg-danger">–ê–∫—Ü–∏—è</span>
          {% else %}
          <span class="position-absolute top-0 start-0 m-2 badge bg-warning text-dark">–ü–æ–ø—É–ª—è—Ä–Ω—ã–π</span>
          {% endif %}

          <img src="{{ t.image_url }}" alt="{{ t.origin }} ‚Üí {{ t.destination }}" class="img-fluid" style="height:180px; object-fit:cover;">
          <div class="card-body d-flex flex-column justify-content-between">
            <div>
              <h5 class="card-title text-primary fw-bold">{{ t.origin }} ‚Üí {{ t.destination }}</h5>
              <p class="card-text mb-1 text-success fw-bold">–¶–µ–Ω–∞: ${{ t.price }}</p>
              {% if t.airline %}
              <p class="mb-2">–†–µ–π—Ç–∏–Ω–≥: ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</p>
              {% endif %}
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ -->
            <button type="button" class="btn btn-outline-primary w-100 mt-3 rounded-pill fw-bold" data-bs-toggle="modal" data-bs-target="#ticketModal{{ t.id }}">
              –í—ã–±—Ä–∞—Ç—å ‚úàÔ∏è
            </button>
          </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="ticketModal{{ t.id }}" tabindex="-1" aria-labelledby="ticketModalLabel{{ t.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
              <div class="modal-header">
                <h5 class="modal-title fw-bold" id="ticketModalLabel{{ t.id }}">–í—ã –≤—ã–±—Ä–∞–ª–∏ –±–∏–ª–µ—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> {{ t.origin }} ‚Üí {{ t.destination }}</p>
                <p><strong>–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞:</strong> {{ t.depart_date }}</p>
                {% if t.return_date %}<p><strong>–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞:</strong> {{ t.return_date }}</p>{% endif %}
                <p><strong>–¶–µ–Ω–∞:</strong> ${{ t.price }}</p>
                {% if t.airline %}<p><strong>–ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è:</strong> {{ t.airline }}</p>{% endif %}
              </div>
              <div class="modal-footer d-flex flex-column" id="modalFooter{{ t.id }}">
                <div id="modalContent{{ t.id }}" class="w-100">
                  <button onclick="showPaymentForm({{ t.id }}, {{ t.price }})" class="btn btn-primary w-100 rounded-pill fw-bold">
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
                  </button>
                  <button type="button" class="btn btn-secondary w-100 rounded-pill mt-2" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
      {% empty %}
      <div class="col-12 text-center">
        <p class="text-muted fs-5">–ë–∏–ª–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòî</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Custom CSS -->
<style>
.ticket-card {
  transition: all 0.3s ease-in-out;
  min-height: 100%;
}

.ticket-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px rgba(0,0,0,0.25);
}

.card-body {
  min-height: 220px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
</style>

<!-- JS -->
<script>
function showPaymentForm(ticketId, price) {
  const modalContent = document.getElementById("modalContent" + ticketId);
  if (!modalContent) return;

  modalContent.innerHTML = `
    <h5 class="fw-bold mb-3 text-center">–û–ø–ª–∞—Ç–∞ –±–∏–ª–µ—Ç–∞</h5>
    <form onsubmit="processPayment(event, ${ticketId})">
      <div class="mb-3">
        <label class="form-label">–ò–º—è –Ω–∞ –∫–∞—Ä—Ç–µ</label>
        <input type="text" class="form-control" placeholder="Ivan Ivanov" required>
      </div>
      <div class="mb-3">
        <label class="form-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
        <input type="text" class="form-control" placeholder="1234 5678 9012 3456" required>
      </div>
      <div class="row">
        <div class="col mb-3">
          <label class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
          <input type="text" class="form-control" placeholder="MM/YY" required>
        </div>
        <div class="col mb-3">
          <label class="form-label">CVV</label>
          <input type="text" class="form-control" placeholder="123" required>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success w-50 fw-bold rounded-pill">–û–ø–ª–∞—Ç–∏—Ç—å $${price}</button>
        <button type="button" class="btn btn-secondary w-50 fw-bold rounded-pill" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  `;
}

function processPayment(e, ticketId) {
  e.preventDefault();
  alert("‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞!");
  const modal = bootstrap.Modal.getInstance(document.getElementById("ticketModal" + ticketId));
  if (modal) modal.hide();
}
</script>
{% endblock %}
